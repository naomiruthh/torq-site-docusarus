<!-- ## Metadata_Start
## title: Create a nested workflow
## original-url : https://learn.torq.io/docs/create-a-nested-workflow
## article-id : 243977fe-1d84-40b4-aba2-7eef00a1dedc
## seo-title : Create nested workflow for Torq automated security workflows
## description : Nested workflows perform a common set of actions and implement content reuse across automated security workflows in Torq.
## category-type : html
## Metadata_End -->
<p>Nested workflows are a good way to perform a common action or set of actions that you intend to reuse across workflows. This is helpful when workflows that achieve different business purposes require the same logic. Content reuse enables you to maintain and update a single workflow and call it wherever you need.</p><h2>Important to know</h2><ul><li>When the parent workflow is published and running, it will only run published nested workflows.</li><li>When the parent workflow is in draft mode, it will run the latest version of the nested workflow (published or latest draft).</li><li>Each run of the nested workflow will have an activity log entry in the parent workflow from which it was triggered.</li></ul><h2>1. Create a nested workflow</h2><p>A nested workflow is a regular workflow with an on-demand trigger. In this example, the nested workflow will enrich IP addresses extracted from a suspicious email.</p><ol><li style="list-style-type: none;"><ol><li>On the <strong>Workflows</strong> page click <strong>Create workflow</strong>.</li><li>Give the workflow a meaningful name, such as IP Enrichment (nested).</li><li>Select the <strong>On-demand</strong> trigger and click <strong>Create workflow</strong>.<br><img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/Create%20a%20workflow%20modal.png" alt="Create a workflow modal with on-demand trigger" class="fr-dib fr-bordered"></li><li>Click the trigger block.&nbsp;</li><li>&nbsp;Add a parameter, define its input, and click <strong>Save</strong>. This example uses a short-text field titled IP Address since the workflow will enrich an IP address.<br><img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/nested%20create%20pparameter.jpg" class="fr-dib fr-bordered" style="width: 800px;" alt="nested create pparameter"></li><li>&nbsp;Add the loop step and define the data that it will loop over, and define the INPUT field as <code>{{ $.event.ip_address }}</code>.<br><img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/loop%20nested.jpg" class="fr-dib fr-bordered" style="width: 800px;" alt="loop nested"></li><li>Add a step that will enrich the IP addresses, for example, VirusTotal.<ol><li>Define the IP_ADDRESS field as <code>{{ $.loop_value }}</code>.</li><li>Select or create the integration if the step requires it.<br><img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/virustottal.jpg" class="fr-dib fr-bordered" style="width: 800px;" alt="virustottal"></li></ol></li><li>&nbsp;Add the <strong>Add to object&nbsp;</strong>step. This step creates an object where the enrichment results will be stored.<ul><li>&nbsp;INPUT: <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">{{ $.ip_results }}</span></li><li>&nbsp;KEY: <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">{{ $.value }}</span></li><li>&nbsp;VALUE: <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">{{ $.get_ip_information.api_object.data.attributes.last_analysis_stats }}</span></li></ul></li><li>&nbsp;Add the step <strong>Add data to context</strong>. The enrichment results are available from the tree view and autocomplete, which can be used in the <strong>Exit</strong>step to define the workflow output schema.<ul><li>INPUT: <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">{{ $.add_specific_ip_results_to_results_object.result }}</span></li></ul></li><li>&nbsp;Add the <strong>Exit</strong> step and enable the <strong>Workflow Output</strong>. The output will be available in the parent workflow.<img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/2023-06-01_16-31-43.jpg" class="fr-fic fr-dib fr-bordered" style="width: 600px;" alt="2023-06-01_16-31-43"></li></ol></li></ol><p><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span></p><h2>2. Create a parent workflow</h2><p>At a minimum, the parent workflow should have a trigger event. This way, you will have data to feed to the nested workflow. Of course, you can include as many steps as you need.</p><p>In this example, the parent workflow is to <strong>Investigate a suspicious email</strong>. The workflow ingests an email from an IMAP integration and extracts indicators to process in the nested enrichment workflows; <strong>IP enrichment</strong>, <strong>Malware enrichment</strong>, and <strong>URL enrichment</strong>.</p><p>The output from the extraction steps is used to create the JSON that feeds each of the nested workflows.</p><ol><li>&nbsp;Add a trigger to the workflow.</li><li>&nbsp;(Optional) Add steps to the workflow.</li><li>&nbsp;Add the <strong>Workflow&nbsp;</strong><strong>operator</strong>.<ol><li>&nbsp;Select a workflow to call as a nested workflow.</li><li>Define the JSON object or list to send to the nested workflow. In this example, the event JSON is:&nbsp;<strong>Extract all URLs result</strong>.</li></ol></li></ol><p><br><img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/nested%20gif%20add%20step.gif" class="fr-fic fr-dib fr-bordered" alt="nested gif add step" style="width: 800px;"></p><h2>3. Access the nested workflow output</h2><p>The output from the nested workflow is accessible in the parent workflow using <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">$.&lt;nested_workflow&gt;.&lt;output_key&gt;</span>.</p><p><br></p><p><br></p>
