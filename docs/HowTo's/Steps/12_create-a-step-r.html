<!-- ## Metadata_Start
## title: Create a step runner
## original-url : https://learn.torq.io/docs/create-a-step-runner
## article-id : a3c0cf38-e092-4ef3-b64f-df12be9ae9d0
## seo-title : Create a step runner with Kubernetes, AWS, or Google Cloud
## description : Create a step runner using Torq's custom step using kubernetes, AWS Elastic Kubernetes Service, self-hosted runners, or Google cloud secret managers
## category-type : html
## Metadata_End -->
<p>Use a step runner to execute steps that require access to components that are hosted in private VPCs or data centers.&nbsp;</p><h2>Configure a self-hosted step runner</h2><ol><li>Go to <strong>Integrations&nbsp;</strong>&gt;<strong>&nbsp;Runner</strong>. Select <strong>Step Runner&nbsp;</strong>and click<strong>&nbsp;Add</strong>.<img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/2022-11-27_15-36-45%20(1)(5).gif" class="fr-dib" alt="Gif of Torq's Integration page, clicking through to the step runner" style="width: 1100px;"></li><li>Enter a meaningful name for the step runner. The name should represent the type (Kubernetes or Docker) and the environment where the runner will be deployed.</li><li>Select either <code>Kubernetes</code> or <code>Docker</code>.<span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span></span></span></li><li><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Click <strong>Add</strong>.</span></span></li><li><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">C</span></span>opy the runner install command. Torq automatically generates a deployment configuration file in YAML format, which is downloaded and executed automatically when running the install command.<section class="infoBox"><div class="title">Note</div><div class="content"><div class="content">The runner install command, new or regenerated, is valid for 24 hours.</div></div></section><img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/copy%20the%20runner%20deployment%20command.png" alt="copy the runner install command" class="fr-dib fr-bordered" style="width: 1003px;"></li><li><a href="/v1/docs/create-a-step-runner#deploy-a-selfhosted-step-runner" rel="nofollow" translate="no">Deploy the self-hosted step runner</a>.</li></ol><h3>Regenerate a runner install command</h3><p>Regenerate the install command for any runner to reinstall it (if unhealthy) or create an additional service that can execute the runner jobs.</p><ol><li>Go to <strong>Integrations</strong> &gt; <strong>Runner</strong>. Select <strong>Step Runner</strong>.</li><li>Locate the runner you want to regenerate the install command for.</li><li>Go to the runner three dots menu and select <strong>Regenerate install command</strong>.<br><img src="https://cdn.document360.io/e159bc51-b5b1-4b1f-af39-a9db2fa968d6/Images/Documentation/Regenerate%20the%20runner%20install%20command.png" alt="Regenerate the runner install command" class="fr-dib fr-bordered" style="width: 1416px;"></li><li>Select the platform in which you want to deploy the runner: Docker/Kubernetes.</li><li>Copy the new install command and run it.</li></ol><h2><p>Deploy a self-hosted step runner</p></h2><p>After you finish defining a new remote step runner, Torq automatically generates a deployment configuration file in YAML format (the file is downloaded automatically) paired with deployment instructions.</p><h2>Deploy using Docker</h2><p>To deploy a runner using Docker, run the install command in a terminal. When done, the runner should be ready to use.</p><h3>Advanced options</h3><p>To customize the runner deployment instructions (which shouldn't be required for most use cases), you can add flags to the automatically generated deployment configuration file.</p><ol><li>Retrieve the content of the automatically generated file. For example, for the following install command: <code>curl -H "Content-Type: application/x-sh" -s -L "https://link.torq.io/***z5v5qBRg21otM8" | sh</code>, run <meta charset="utf-8"><span style="color: rgb(34, 34, 34); font-family: Inter, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><code>Content-Type: application/x-sh" -s -L "https://link.torq.io/***z5v5qBRg21otM8</code></span>.</li><li>Copy the command output and paste it into a fresh line.&nbsp;</li><li>Add flags according to your needs. These are two examples:<ul><li>Specify a proxy server: <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span><code>-e https_proxy=http://XXXXXXX:PORT</code><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span>. <span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span>Make sure you replace <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span><code>XXXXXXX:PORT</code> with your actual proxy address and port.</li><li>Connect to a bridge network: <meta charset="utf-8"><span style="color: rgb(34, 34, 34); font-family: Inter, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><code>-e DOCKER_NETWORK_ID='XXXXXXXXXXX' -e DOCKER_NETWORK_NAME='XXXXXXXXXX'</code>.&nbsp;</span>A <a href="https://docs.docker.com/network/drivers/bridge/" rel="nofollow" translate="no">bridge network</a> uses a software bridge that allows containers connected to the same bridge network to communicate while providing isolation from containers that are not connected to that bridge network.<span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span></span><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span></span><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span></li></ul></li><li><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Run the edited deployment configuration file.</span></span></li><li><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Run <code>docker ps</code><meta charset="utf-8"><meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><meta charset="utf-8"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">&nbsp;to confirm that the service is running. </span></span></span></span><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span></span></span></span></li></ol><p><span class="fr-video fr-deletable fr-dvb fr-draggable" contenteditable="false" draggable="true"><iframe width="640" height="360" src="https://www.youtube.com/embed/zOcZ4JRZchs?&amp;wmode=opaque&amp;rel=0" frameborder="0" allowfullscreen="" class="fr-draggable"></iframe></span><br></p><h2>Deploy using Kubernetes&nbsp;</h2><h3>Allow Kubernetes cluster management actions&nbsp;</h3><p>If you select the <strong>Allow Kubernetes cluster management actions</strong> option, workflow steps executed using this runner can take actions on the Kubernetes cluster itself. The auto-generated Kubernetes resources will include a <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" rel="nofollow noopener noreferrer" target="_blank" translate="no">ClusterRole</a> resource allowing Get and List access to resources, such as <em>Pods</em>, <em>Pod Logs</em>, <em>Events</em>, <em>Nodes</em>, <em>Configmaps</em>, <em>Deployments</em>, and <em>Horizontal Pod Autoscalers</em>. Another automatically generated ClusterRoleBinding object will automatically bind this role to all steps executed by the runner.&nbsp;</p><section class="warningBox"><div class="title"><div class="content"><strong>Important</strong><br><br><p>If you don't select this option, the steps will not be able to perform any actions on the Kubernetes cluster they are running on. This may not prevent them from accessing external services. If the operations listed above are not sufficient, and workflow steps are expected to perform additional operations on the cluster, the <strong>ClusterRole</strong> can be modified and re-applied to the cluster. Alternatively, you can create a dedicated Kubernetes integration to manage specific permissions for specific steps.</p></div></div></section><p>Below is a default configuration for the ClusterRole and ClusterRoleBinding objects that are automatically added to the speed runner deployment when the <strong>Allow Kubernetes cluster management actions</strong> option is selected:</p><pre><code class="language-yaml" data-code-id="section-1669544267425" data-language="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: torq-step
rules:
- apiGroups:
  - ""
  resources:
  - pods
  - pods/log
  - events
  - nodes
  - configmaps
  verbs:
  - get
  - list
- apiGroups:
  - apps/v1
  resources:
  - deployments
  verbs:
  - get
  - list
- apiGroups:
  - autoscaling
  resources:
  - horizontalpodautoscalers
  - horizontalpodautoscalers/status
  verbs:
  - '*'
- apiGroups:
  - metrics.k8s.io
  resources:
  - pods
  - nodes
  verbs:
  - get
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: torq-step
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: torq-step
subjects:
- kind: ServiceAccount
  name: default
  namespace: torq</code></pre><p><span class="fr-video fr-deletable fr-dvb fr-draggable" contenteditable="false" draggable="true"><iframe width="640" height="360" src="https://www.youtube.com/embed/k93n3kBL0NY?&amp;wmode=opaque&amp;rel=0" frameborder="0" allowfullscreen="" class="fr-draggable"></iframe></span><br></p><h3>Use an existing Kubernetes clusters</h3><p>The configuration YAML file contains resource definitions for all the resources required to run step runner pods and execute steps. To apply the configuration to the cluster, run <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">kubectl apply -f &lt;file path&gt;</span></p><p><meta charset="utf-8"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">All Torq resources are created inside dedicated&nbsp;</span><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" rel="nofollow noopener noreferrer" target="_blank" translate="no"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Kubernetes namespaces</span></a><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">&nbsp;(torq for the Torq agent itself and for jobs of various steps), allowing for simple monitoring and removal by issuing a <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">kubectl delete namespace &lt;namespace-name&gt;</span> command.</span></p><h3>Use AWS Elastic Kubernetes Service (EKS)</h3><p>For Amazon Web Services users that do not use Kubernetes Cluster, the easiest way to deploy a self-hosted step runner is to establish a managed Kubernetes Cluster using AWS <a href="https://aws.amazon.com/eks/" rel="nofollow noopener noreferrer" target="_blank" translate="no">Elastic Kubernetes Service</a>. Creation and management of the cluster can be achieved using a number of simple steps defined below. Hosting a Torq step runner on the cluster is a straightforward step.</p><h4>1. Install AWS CLI, eksctl, kubectl&nbsp;</h4><p>To simplify creating an EKS Cluster, it is recommended to use the AWS ClI and eksctl command-line tools provided by Amazon Web Services. To control the Kubernetes cluster, you should install and configure a kubectl command-line tool.</p><p>This <a href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html" rel="nofollow noopener noreferrer" target="_blank" translate="no">step-by-step guide</a> from Amazon Web Services provides all the information necessary to download and configure the tools.</p><p>In order to configure the AWS command-line utility, a set of AWS Credentials is required. This guide from AWS explains how to <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html" rel="nofollow noopener noreferrer" target="_blank" translate="no">configure the command-line utility</a>. <span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"></span></p><p>Generally, executing AWS configuration and providing the authentication credentials will prepare the system for operation:&nbsp;</p><pre><code class="language-none" data-code-id="section-1669545954864" data-language="none">aws configure
AWS Access Key ID [********************]:
AWS Secret Access Key [********************]:
Default region name [us-east-2]:
Default output format [None]:</code></pre><h4>2. Create an EKS cluster</h4><p>Eksctl utility is the simplest way to create an EKS cluster. The utility can be used in two modes:&nbsp;</p><p>The<strong>&nbsp;imperative mode&nbsp;</strong>receives all the information about the cluster in the command-line arguments, similar to the following example.&nbsp;</p><pre><code class="language-none" data-code-id="section-1669546061829" data-language="none">eksctl create cluster \
  --name torq-steps \
  --version 1.17 \
  --region us-east-2 \
  --nodegroup-name linux-nodes \
  --node-type t3.small \
  --nodes 2 \
  --nodes-min 1 \
  --nodes-max 2 \
  --ssh-access \
  --ssh-public-key my-public-key.pub \
  --managed</code></pre><p>The <strong>infrastructure-as-code</strong> mode uses all cluster definitions defined in a YAML file that is provided to the utility execution. Below is a sample YAML configuration file for the <a href="https://github.com/weaveworks/eksctl" rel="nofollow noopener noreferrer" target="_blank" translate="no">eksctl</a> utility:</p><pre><code class="language-yaml" data-code-id="section-1669546153656" data-language="yaml">apiVersion: eksctl.io/v1alpha5 
kind: ClusterConfig

metadata: 
  name: torq-steps 
  region: us-east-2

nodeGroups: 
  - name: torq-steps-ng-1 
    instanceType: t3.small 
    desiredCapacity: 2</code></pre><p>To apply this configuration, call: <code>eksctl create cluster -f &lt;path_to_configuration_yaml&gt;</code></p><p><code><meta charset="utf-8"></code></p><section class="infoBox"><div class="title">Note</div><div class="content"><p>Torq requires a minimum of <strong>2 vCPUs&nbsp;</strong>and <strong>2GB RAM&nbsp;</strong>for the nodes in a Kubernetes cluster to ensure the ability to execute steps during a workflow run.</p></div></section><section class="warningBox"><div class="title">Important</div><div class="content"><p>One of the benefits of using <strong>eksctl</strong> utility is that it simplifies the later usage of the Kubernetes cluster by creating a <strong>kubeconfig</strong> file (later to be used by the <em>kubectl</em> utility). EKS Cluster(s) can be created using other means, such as but not limited to, AWS Console or a dedicated AWS EKS Terraform Module, but then, the <strong>kubeconfig</strong> creation will become the responsibility of the user.</p></div></section><p>Running <em>eksctl&nbsp;</em>will update the <a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" rel="nofollow noopener noreferrer" target="_blank" translate="no">kubeconfig</a> file (by default a file named <font color="#de0421" face="Roboto Mono, Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace"><span style="font-size: 14px; letter-spacing: normal; background-color: rgb(245, 247, 247);">config</span></font><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">&nbsp;located under <meta charset="utf-8"><span style="color: rgb(222, 4, 33); font-family: &quot;Roboto Mono&quot;, Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(245, 247, 247); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">$HOME/.kube<meta charset="utf-8"><span style="color: rgb(34, 34, 34); font-family: Nunito, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">&nbsp;with the details of the newly created cluster and will automatically change the context to it.&nbsp;</span></span></span></span></p><h4>3. Deploy the step runner</h4><p>After the EKS cluster is created, you deploy the step runner using exactly the same procedure as in any other Kubernetes Cluster.</p><p><br><strong>Use K3S on any server</strong></p><p>The fastest and easiest way to deploy a production-grade Kubernetes cluster (for small tasks) on any virtual (or physical) machine is by using a <a href="https://k3s.io/" rel="nofollow noopener noreferrer" target="_blank" translate="no">K3S</a> Kubernetes distribution. K3S, originally developed by <a href="https://www.rancher.com/" rel="nofollow noopener noreferrer" target="_blank" translate="no">Rancher</a> is a CNCF Sandbox Project that can be deployed on any x85_64, ARMv7 or ARM64 server within ~30 seconds (according to the developer website).</p><p>Step-by-step deployment instructions are available on the K3S Site. After deploying K3S cluster, you can deploy the step runner using the exact same procedure as in any other Kubernetes Cluster.</p><h3>Audit and troubleshoot self-hosted runners</h3><p>While a step runner is a simple component that doesn't require any special configuration or treatment, being able to audit its operations and, when required, troubleshoot its activity can help resolve challenging situations. The below commands suggest how to get an insight into an activity performed by a step runner.</p><h4>Step execution events</h4><p>All steps are executed in the Kubernetes namespace called "torq" (Kubernetes is assumed as a default step runner adapter).</p><p>Using <strong>kubectl</strong> to get the list of events that took place in the namespace using <code>kubectl get events --namespace=torq</code></p><p>The output should consist of the following types of events:</p><ul><li><strong>Pulled</strong>: Container image for a specific step was pulled from the container registry</li><li><strong>Created</strong>: Container, based on the pulled image, was created in preparation to execute the step</li><li><strong>Started</strong>: Step container execution started</li></ul><p>Additional events can indicate longer processes, such as Pulling, Scheduled, and others.</p><h4>Find step execution jobs</h4><p>When workflows are running, steps are initiated by the step runner as jobs in the torq Kubernetes namespace. To view the currently-running jobs, use <meta charset="utf-8"><span style="color: rgb(232, 62, 140); font-family: SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">kubectl get jobs --namespace=torq</span></p><h4>Pull step runner logs</h4><p>The step runner is a Kubernetes Pod running in the "torq" namespace. In order to retrieve its logs, first one should find the Pod name by issuing <span style="color: rgb(232, 62, 140); font-family: SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">kubectl get pods &nbsp;--namespace=torq</span></p><p>Then, using the Pod name retrieved, to see the detailed logs using <meta charset="utf-8"><span style="color: rgb(232, 62, 140); font-family: SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.48px; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">kubectl logs &lt;POD_NAME&gt; &nbsp;--namespace=torq</span></p><h3>URLs the runner uses to communicate with Torq</h3><p>Step runners use the following URLs to communicate with Torq.</p><table style="width: 100%;"><tbody><tr><td style="width: 50.0000%;">URL</td><td style="width: 50.0000%;">Purpose</td></tr><tr><td style="width: 50.0000%;"><a href="https://us-docker.pkg.dev/​" translate="no">https://us-docker.pkg.dev/<br></a></td><td style="width: 50.0000%;">Used to pull the runner image (one time)</td></tr><tr><td style="width: 50.0000%;"><a href="https://link.torq.io/" rel="noopener noreferrer" target="_blank" translate="no">https://link.torq.io/<br></a></td><td style="width: 50.0000%;">Used to pull configurations (one time)</td></tr><tr><td style="width: 50.0000%;"><a href="https://pubsub.googleapis.com/" rel="noopener noreferrer" target="_blank" translate="no">https://pubsub.googleapis.com/<span style="white-space:pre;">&nbsp; &nbsp;&nbsp;</span><br></a></td><td style="width: 50.0000%;">Used to communicate with the Torq service</td></tr><tr><td style="width: 50.0000%;"><a href="https://storage.googleapis.com/" rel="noopener noreferrer" target="_blank" translate="no">https://storage.googleapis.com/ &nbsp; &nbsp;</a></td><td style="width: 50.0000%;">Used to upload logs</td></tr><tr><td style="width: 50.0000%;"><a href="https://auth.googleapis.com/" rel="noopener noreferrer" target="_blank" translate="no">https://auth.googleapis.com/</a></td><td style="width: 50.0000%;"><p>Used for authentication</p></td></tr></tbody></table><p>For a full list of IP addresses that Google uses, see the following links:</p><ul><li><a href="https://cloud.google.com/vpc/docs/configure-private-google-access#ip-addr-default" rel="noopener noreferrer" target="_blank" translate="no">https://cloud.google.com/vpc/docs/configure-private-google-access#ip-addr-default</a></li><li><a href="https://www.gstatic.com/ipranges/cloud.json" rel="nofollow noopener noreferrer" target="_blank" translate="no">https://www.gstatic.com/ipranges/cloud.json</a></li></ul><h3>Use an external secrets manager</h3><p>Torq provides the Custom Secrets integration, which is a secure way of managing secrets, such as credentials, keys, etc., that you can use in workflow steps. This is a convenient way to store sensitive data (without it being exposed in the UI) and to be able to reuse it in workflows running across different environments.</p><p>In some cases, when executing specific steps inside "closed" environments, you might need to store secrets used by specific steps outside of the Torq environment. Torq steps can implement fetching secrets locally from external secret management solutions, such as (but not limited to) <a href="https://aws.amazon.com/secrets-manager/" rel="nofollow noopener noreferrer" target="_blank" translate="no">AWS Secrets Manager</a>, <a href="https://cloud.google.com/secret-manager" rel="nofollow noopener noreferrer" target="_blank" translate="no">Google Cloud Secret Manager</a>, or <a href="https://azure.microsoft.com/en-us/products/key-vault/" rel="nofollow noopener noreferrer" target="_blank" translate="no">Azure Key Vault</a>. Integration steps support these solutions where applicable.</p><p>The mechanism for using an external secret manager is described below. We will use an example of an <em>ssh-command</em> step to demonstrate the differences between having the SSH Certificate stored in the <strong>Custom Integration</strong> in Torq, AWS Secrets Manager, and Google Cloud Secret Manager.</p><p>In order for the step to retrieve a secret from an external system, the following tasks should be done ahead of time:</p><ul><li>A secret (in our example - SSH certificate) should be stored in the external system.</li><li>If AWS Secrets Manager is used, the following aws-cli command can be used:</li></ul><pre><code class="language-none" data-code-id="section-1669552221213" data-language="none">aws secretsmanager create-secret --name &lt;SECRET_NAME&gt; \
      --description "&lt;SECRET_DESCRIPTION&gt;" \
      --secret-string &lt;FILE_CONTAINING_SECRET_DATA&gt;`</code></pre><p>If Google Cloud Secret Manager is used, the following <em>gcloud cli</em> command can be used:</p><pre><code class="language-none" data-code-id="section-1669552246621" data-language="none">gcloud secrets create &lt;SECRET_NAME&gt; \
  --data-file="&lt;FILE_CONTAINING_SECRET_DATA&gt;" \
  --replication-policy=automatic</code></pre><p><br></p><ol><li>Define a Service Account (GCP) or a User with Programmatic Access (AWS) and provide these with the relevant permissions to access secrets. AWS provides a built-in <code>arn:aws:iam::aws:policy/SecretsManagerReadWrite</code> policy, however, it allows excessive permissions. It is recommended to construct a dedicated policy containing <code>Secrets Manager : DescribeSecret</code> and <code>Secrets Manager : GetSecretValue</code> permissions. Similarly, in GCP the service account would need <code>secretmanager.secrets.get</code> and <code>secretmanager.secrets.access</code> permissions.</li><li>Store the Service Account credentials in the Custom Secrets integration and define an access policy to the secret objects. By doing so, the service accounts will be (in the following steps) provided the steps in the workflows that need to retrieve the actual secrets from the external secret management system, and the IAM policy can restrict access for specific environments (ensuring that, for example, only the jobs running in specific locations can get access).</li><li>In the workflow, make sure that the service account data is being passed to the relevant steps. (This will allow the steps to assume the role and pull the actual secret, providing it is allowed by the IAM policy).</li><li>Use (or implement) steps that support retrieving secrets from the relevant secret managers. Below example demonstrates <code>ssh-command</code> step in different flavors, using AWS Secrets Manager or Google Cloud Secret Manager to retrieve the actual SSH Certificate for the connection:</li></ol><pre><code class="language-yaml" data-code-id="section-1669555794333" data-language="yaml">- id: run_ssh_command_on_remote_host
    name: us-docker.pkg.dev/torq/public/ssh-command-aws-secret:rc0.7
    runner: aws-env
    env: 
      SSH_CLIENT: "{{ .UserName }}@{{ .ServerAddress }"
      SSH_COMMAND: |
        uname -a;
        df -k;
        ls -l ~/
      AWS_ACCESS_KEY_ID: '{{ secret "AWS_SECRET_MANAGER_ROLE_KEY" }}'
      AWS_SECRET_ACCESS_KEY: '{{ secret "AWS_SECRET_MANAGER_ROLE_SECRET" }}'
      SSH_KEY_SECRET_NAME: 'MySSHKey'
    output_parser:
      name: us-docker.pkg.dev/torq/public/raw-output-parser</code></pre><p>As shown in the example, the step expects to receive credentials for the role that'd allow it to retrieve the actual SSH Certificate, stored in a secret named <code>MySSHKey</code> in the AWS Secrets Manager. Naturally, this is just an example, and the secret can be anything, not just an SSH Certificate.</p><p>The credentials stored in <strong>AWS_SECRET_MANAGER_ROLE_KEY</strong> and <strong>AWS_SECRET_MANAGER_ROLE_SECRET</strong> are the ones for the user account with programmatic access, as defined in step #2 above.</p><h3>Google Cloud secret manager</h3><pre><code class="language-yaml" data-code-id="section-1669555859890" data-language="yaml">- id: run_ssh_command_on_remote_host 
    name: us-docker.pkg.dev/torq/public/ssh-command-gcloud-secret:rc0.7
    runner: gcp-env
    env: 
      SSH_CLIENT: "{{ .UserName }}@{{ .ServerAddress }"
      SSH_COMMAND: |
        uname -a;
        df -k;
        ls -l ~/
            AUTH_CODE: '{{ secret "GCP_SECRET_MANAGER_ACCOUNT_TOKEN"}}'
      SSH_KEY_SECRET_NAME: 'MySSHKey'
    output_parser:
      name: us-docker.pkg.dev/torq/public/raw-output-parser</code></pre><p>In this example, the step expects to receive a <strong>base64</strong>-encoded version of the authentication token for a service account in AUTH_CODE environment variable. Then, assuming the role of this service account, the actual SSH Certificate will be retrieved from a secret named <strong>MySSHKey</strong>.</p>
